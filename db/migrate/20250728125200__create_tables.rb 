class CreatePaymentSchema < ActiveRecord::Migration[7.0]
  def up
    # --- ENUM Types ---
    # It's often better to manage ENUMs directly in SQL for full control.
    execute <<-SQL
      CREATE TYPE job_status AS ENUM ('pending', 'success', 'failed');
      CREATE TYPE currency AS ENUM ('AUD', 'USD', 'SGD', 'VND');
      CREATE TYPE payment_status AS ENUM ('pending', 'exporting', 'exported');
    SQL

    # --- Tables ---

    # Create the 'companies' table
    create_table :companies do |t|
      t.string :name, null: false
      t.boolean :active, null: false, default: true
    end

    # Add the unique partial index for active company names
    add_index :companies, :name, unique: true, where: "active = true", name: 'one_active_company_name'

    # Create the 'jobs' table
    create_table :jobs do |t|
      # Use the native enum type defined above
      t.enum :status, enum_type: 'job_status', default: 'pending', null: false
      t.datetime :executed_at
      t.datetime :updated_at
      t.string :output
    end

    # Create the 'payments' table
    # Use :uuid for the primary key
    create_table :payments, id: :uuid do |t|
      t.uuid :employee_id, null: false
      t.uuid :batch_id, null: false
      t.string :bsb, limit: 6, null: false
      t.string :account, limit: 9, null: false
      t.bigint :amount_cents, null: false
      t.date :pay_date, null: false

      # Use the native enum types defined above
      t.enum :currency, enum_type: 'currency', default: 'AUD', null: false
      t.enum :status, enum_type: 'payment_status', default: 'pending', null: false

      # Foreign keys
      t.references :company, type: :bigint, null: false, foreign_key: true
      t.references :job, type: :bigint, null: true, foreign_key: true

      t.timestamps
    end

    # --- Indexes ---

    # Add the unique partial index for pending payments in a batch
    add_index :payments, [:employee_id, :company_id, :batch_id],
              unique: true,
              where: "status = 'pending'",
              name: 'one_pending_payment_per_batch'
  end

  def down
    # Drop tables in reverse order of creation to respect foreign keys
    drop_table :payments
    drop_table :jobs
    drop_table :companies

    # Drop the ENUM types
    execute <<-SQL
      DROP TYPE payment_status;
      DROP TYPE currency;
      DROP TYPE job_status;
    SQL
  end
end